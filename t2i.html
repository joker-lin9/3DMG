<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>文生图生成器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b0f14;--card:#121820;--muted:#97a3b6;--text:#e6edf3;--acc:#4da3ff;--acc2:#27d796;--danger:#ff5c7a}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141b);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:860px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #1d2530;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 8px;font-size:22px}
    p.sub{margin:0 0 16px;color:var(--muted)}
    nav{max-width:860px;margin:16px auto 0;padding:0 16px;display:flex;gap:8px;align-items:center;justify-content:flex-end;font:14px ui-sans-serif}
    nav a{color:#97a3b6;text-decoration:none;border:1px solid #2b3544;padding:6px 10px;border-radius:10px}
    nav a.active{color:#0b1220;background:#4da3ff;border-color:#3288e9;font-weight:600}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 320px}
    input, textarea{width:100%;background:#101620;border:1px solid #273141;color:var(--text);padding:10px 12px;border-radius:10px}
    .btn{padding:10px 14px;border:1px solid #2f3a4f;background:#1a2331;color:var(--text);border-radius:12px;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn.primary{background:linear-gradient(90deg,var(--acc),#6ad0ff);border-color:#3288e9;color:#0b1220;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .tag{font-size:12px;padding:4px 8px;border:1px solid #2a3346;border-radius:999px;color:var(--muted)}
    .item{border:1px solid #273141;border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center}
    .thumb{width:128px;height:128px;border:1px solid #273141;border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#0f1722}
    .thumb img{max-width:100%;max-height:100%;object-fit:contain}
    .err{color:var(--danger)}

    /* 查看大图弹窗 */
    #imgViewer{border:1px solid #263144;border-radius:14px;padding:0;background:#0b0f14;max-width:92vw;max-height:92vh}
    #imgViewer::backdrop{background:rgba(0,0,0,.55)}
    #viewerWrap{padding:12px;display:flex;align-items:center;justify-content:center}
    #viewerImg{max-width:90vw;max-height:80vh;object-fit:contain}
    #viewerBar{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border-top:1px solid #263144;background:#0e141b}
    #viewerBar .btn{padding:8px 12px;border:1px solid #2f3a4f;background:#1a2331;color:#e6edf3;border-radius:10px}

    /* 占位提示：初始不渲染 <img>，先显示这段 */
    .thumb { position: relative; }
    .thumb .ph {
    width: 100%; height: 100%;
    display:flex; align-items:center; justify-content:center;
    color:#97a3b6; font-size:12px; padding:8px; text-align:center;
    }

  </style>
</head>
<body>
  <nav>
    <a href="./i23D.html">白模生成</a>
    <a href="./t2i.html" class="active">文生图</a>
  </nav>

  <div class="wrap">
    <div class="card">
      <h1>文生图生成器</h1>
      <p class="sub">输入绘画风格 + 多个主体对象（+ 号可添加多个）。每个主体单独生成与展示；点击可放大预览，支持单张下载（文件名=主体名）。</p>

      <div class="row">
        <div class="col">
          <label>绘画风格</label>
          <input id="style" placeholder="如：卡通, 写实, 科幻..."/>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <label>主体对象</label>
          <div id="subjects"></div>
          <button id="add" class="btn" style="margin-top:8px">+ 新增主体</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="col">
          <button id="start" class="btn primary" disabled>开始生成</button>
          <span id="tip" class="tag" style="margin-left:8px">主体至少 1 个</span>
        </div>
      </div>

      <div id="list" style="display:none; margin-top:16px; display:flex; flex-direction:column; gap:12px"></div>
      <div id="error" class="err" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- 查看大图弹窗（全局仅一份） -->
  <dialog id="imgViewer">
    <div id="viewerWrap">
      <img id="viewerImg" alt="viewer"/>
    </div>
    <div id="viewerBar">
      <div style="color:#97a3b6;font-size:12px" id="viewerName"></div>
      <div style="display:flex;gap:8px">
        <a id="viewerDownload" class="btn" download>下载当前图片</a>
        <form method="dialog"><button class="btn">关闭</button></form>
      </div>
    </div>
  </dialog>

  <script>
    // === 配置你的后端地址（与 t2i_API.py 端口一致）===
    const API_BASE = 'http://127.0.0.1:5023';

    // === DOM refs ===
    const $style = document.getElementById('style');
    const $subjects = document.getElementById('subjects');
    const $add = document.getElementById('add');
    const $start = document.getElementById('start');
    const $list = document.getElementById('list');
    const $error = document.getElementById('error');

    // 查看大图弹窗 refs
    const $imgViewer = document.getElementById('imgViewer');
    const $viewerImg = document.getElementById('viewerImg');
    const $viewerName = document.getElementById('viewerName');
    const $viewerDownload = document.getElementById('viewerDownload');

    // === 表单与校验 ===
    function makeSubjectInput(v=''){
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.gap = '8px';
      wrap.style.marginTop = '6px';
      const inp = document.createElement('input');
      inp.placeholder = '输入一个主体，如：红色的狐狸';
      inp.value = v;
      const del = document.createElement('button');
      del.className = 'btn';
      del.textContent = '删除';
      del.onclick = ()=>{ wrap.remove(); checkStart(); };
      wrap.appendChild(inp);
      wrap.appendChild(del);
      return wrap;
    }
    function subjectsValues(){
      return Array.from($subjects.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
    }
    function checkStart(){
      const styleOk = $style.value.trim().length > 0;
      const hasValidSubject = subjectsValues().length > 0; // 至少有一个主体有值
      $start.disabled = !(styleOk && hasValidSubject);
    }
    $style.addEventListener('input', checkStart);
    $style.addEventListener('focusout', checkStart, true);
    $subjects.addEventListener('input', (e)=>{ if (e.target.tagName==='INPUT') checkStart(); });
    $subjects.addEventListener('focusout', (e)=>{ if (e.target.tagName==='INPUT') checkStart(); }, true);
    document.addEventListener('click', (e)=>{
      const insideSubjects = e.target.closest('#subjects') !== null;
      const insideStyle = e.target === $style || $style.contains(e.target);
      if (!insideSubjects && !insideStyle) setTimeout(checkStart, 0);
    });
    $add.addEventListener('click', ()=>{ $subjects.appendChild(makeSubjectInput()); checkStart(); });
    // 初始化一个输入框
    $subjects.appendChild(makeSubjectInput());
    checkStart();

    // === 结果项渲染 ===
    function createItemRow(idx, subject){
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
        <div class="thumb" id="thumb-${idx}">
        <div class="ph" id="ph-${idx}">待生成…</div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
            <div><strong>#${idx+1}</strong> <span id="s-${idx}">${subject}</span></div>
            <span id="st-${idx}" class="tag">等待中</span>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button type="button" class="btn zoom-btn" data-idx="${idx}">查看大图</button>
            <a class="btn dl-btn" id="dl-${idx}" download>下载图片</a>
        </div>
        </div>`;
    return row;
    }

    // 点击“查看大图” —— 事件委托在列表容器上
    $list.addEventListener('click', (e)=>{
      const btn = e.target.closest('.zoom-btn');
      if (!btn) return;
      const i = Number(btn.dataset.idx);
      const imgEl = document.getElementById(`img-${i}`);
      const src = imgEl?.src;
      if (!src) return;
      const subj = document.getElementById(`s-${i}`).textContent || `image-${i}`;
      $viewerImg.src = src;
      $viewerName.textContent = subj;
      $viewerDownload.href = src;
      $viewerDownload.download = `${subj}.png`;
      if (typeof $imgViewer.showModal === 'function') $imgViewer.showModal(); else window.open(src, '_blank');
    });

    // === 拉图与重试（避免偶发 202/非图片响应导致某张丢失）===
    const fetched = new Set();
    async function fetchImageWithRetry(jobId, i, attempt = 0) {
    // ✅ 如果已经成功设置过这张图，直接返回
    if (fetched.has(i)) return;

    try {
        const res = await fetch(`${API_BASE}/t2i/result/${jobId}/${i}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const ct = res.headers.get('content-type') || '';
        if (!ct.startsWith('image/')) throw new Error(`not image: ${ct}`);

        const b = await res.blob();
        const url = URL.createObjectURL(b);

        // ✅ 只在拿到有效 blob 后，创建 <img>，不会出现破图
        setImageForIndex(i, url);

        // ✅ 设置下载按钮
        const subj = document.getElementById(`s-${i}`).textContent || `image-${i}`;
        const dl = document.getElementById(`dl-${i}`);
        dl.href = url;
        dl.download = `${subj}.png`;

        // ✅ 标记已完成，之后不再重复拉取
        fetched.add(i);
    } catch (e) {
        // 指数退避重试，防止首次 202/缓存等导致“丢图”
        if (attempt < 10) {
        const delay = 300 * Math.pow(1.6, attempt); // 300ms, 480ms, 768ms...
        setTimeout(() => fetchImageWithRetry(jobId, i, attempt + 1), delay);
        } else {
        console.warn(`取图重试失败 index=${i}:`, e);
        // 可选：占位符显示失败文案
        const ph = document.getElementById(`ph-${i}`);
        if (ph) ph.textContent = '加载失败';
        }
    }
    }
    function setImageForIndex(i, url){
    const thumb = document.getElementById(`thumb-${i}`);
    const ph = document.getElementById(`ph-${i}`);
    // 已经有图就不重复
    if (document.getElementById(`img-${i}`)) {
        ph && ph.remove();
        return;
    }
    const img = document.createElement('img');
    img.id = `img-${i}`;
    img.alt = `image-${i}`;
    img.loading = 'lazy';
    img.decoding = 'async';
    // 出错时恢复占位，不显示破图
    img.addEventListener('error', ()=>{
        if (img.parentNode) img.parentNode.removeChild(img);
        if (ph) ph.textContent = '加载失败';
        else {
        const _ph = document.createElement('div');
        _ph.className = 'ph';
        _ph.id = `ph-${i}`;
        _ph.textContent = '加载失败';
        thumb.appendChild(_ph);
        }
    });
    img.src = url; // 先绑定 onerror，再设置 src
    thumb.appendChild(img);
    ph && ph.remove();
    }

    // === 启动任务 ===
    async function startJob(){
      $error.textContent='';
      const style = $style.value.trim();
      const subjects = subjectsValues();
      if(!style || subjects.length===0){ $error.textContent='请填写绘画风格并至少一个主体'; return; }
      $start.disabled = true;
      fetched.clear();

      try{
        const res = await fetch(`${API_BASE}/t2i/`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({style, subjects})
        });
        const j = await res.json();
        if(!res.ok || j.code!==1) throw new Error(j.error || '提交失败');
        const jobId = j.job_id;

        // 渲染列表
        $list.innerHTML = ''; $list.style.display='flex';
        subjects.forEach((s,i)=> $list.appendChild(createItemRow(i, s)) );

        // SSE 优先；失败则轮询兜底
        let es = null;
        const startPollingFallback = ()=>{
          const poll = setInterval(async ()=>{
            try{
              const r = await fetch(`${API_BASE}/t2i/progress/${jobId}`);
              const p = await r.json();
              if (p.code === 1){
                p.items.forEach((it,i)=>{
                  document.getElementById(`st-${i}`).textContent = it.status;
                  if (it.status === 'SUCCEEDED' && !fetched.has(i)){
                    fetchImageWithRetry(jobId, i);
                  }
                });
                if (p.done === p.total){ clearInterval(poll); $start.disabled = false; }
              }
            }catch(_){}
          }, 1000);
        };

        if ('EventSource' in window){
          try{
            es = new EventSource(`${API_BASE}/t2i/events/${jobId}`);
            es.onmessage = (ev)=>{
              try{
                const d = JSON.parse(ev.data);
                if (d.item){
                  const i = d.item.index;
                  document.getElementById(`st-${i}`).textContent = d.item.status;
                  if (d.item.status === 'SUCCEEDED' && !fetched.has(i)){
                    fetchImageWithRetry(jobId, i);
                  }
                }
                if (d.overall && (d.overall.status==='done' || d.overall.status==='error')){
                  es.close(); $start.disabled = false;
                }
              }catch(e){
                console.error('SSE 数据解析失败：', e, ev.data);
              }
            };
            es.onerror = ()=>{ es.close(); startPollingFallback(); };
          }catch(_){ startPollingFallback(); }
        }else{
          startPollingFallback();
        }
      }catch(e){
        console.error(e);
        $error.textContent = '❌ ' + (e.message || '提交失败');
        $start.disabled = false;
      }
    }

    $start.addEventListener('click', startJob);
  </script>
</body>
</html>
